#!/usr/bin/env python3
"""
Standalone script to cleanup test data generated by generate_test_data.py

This script deletes the "Direction G√©n√©rale" organization unit, which will
cascade delete all children (organization units and positions).

Usage:
    python cleanup_test_data.py
    
Or with custom Python environment:
    /path/to/venv/bin/python cleanup_test_data.py
"""

import os
import sys
from pathlib import Path
from dotenv import load_dotenv

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent))

from conftest import get_service_logger
import requests

logger = get_service_logger('cleanup_data')

# Load environment variables
load_dotenv(dotenv_path=os.path.join(os.path.dirname(__file__), '.env.test'))


def main():
    """Cleanup test data by deleting Direction G√©n√©rale (cascade delete)."""
    
    # Configuration from .env.test
    base_url = os.getenv('WEB_URL')
    login = os.getenv('LOGIN')
    password = os.getenv('PASSWORD')
    
    logger.info("=" * 80)
    logger.info("üßπ Cleanup Test Data - Delete Direction G√©n√©rale")
    logger.info("=" * 80)
    logger.info(f"Base URL: {base_url}")
    logger.info(f"Login: {login}")
    
    # Step 1: Authenticate
    logger.info("\nüîê Step 1: Authenticating...")
    session = requests.Session()
    session.verify = False  # Disable SSL verification for local testing
    
    login_response = session.post(
        f"{base_url}/api/auth/login",
        json={"email": login, "password": password}
    )
    
    if login_response.status_code != 200:
        logger.error(f"‚ùå Login failed: {login_response.status_code} - {login_response.text}")
        return 1
    
    cookies = {
        'access_token': login_response.cookies.get('access_token'),
        'refresh_token': login_response.cookies.get('refresh_token')
    }
    
    # Get company_id
    verify_response = session.get(
        f"{base_url}/api/auth/verify",
        cookies=cookies
    )
    
    if verify_response.status_code != 200:
        logger.error(f"‚ùå Verify failed: {verify_response.status_code}")
        return 1
    
    company_id = verify_response.json()['company_id']
    logger.info(f"‚úÖ Authenticated - Company ID: {company_id}")
    
    # Step 2: Find Direction G√©n√©rale
    logger.info("\nüîç Step 2: Finding 'Direction G√©n√©rale'...")
    
    list_response = session.get(
        f"{base_url}/api/identity/organization_units",
        cookies=cookies
    )
    
    if list_response.status_code != 200:
        logger.error(f"‚ùå Failed to list organization units: {list_response.status_code}")
        return 1
    
    org_units = list_response.json()
    direction_generale = None
    
    for unit in org_units:
        if unit.get('name') == 'Direction G√©n√©rale':
            direction_generale = unit
            break
    
    if not direction_generale:
        logger.warning("‚ö†Ô∏è 'Direction G√©n√©rale' not found - nothing to clean up")
        logger.info("üí° Maybe it was already deleted, or data was never generated?")
        return 0
    
    logger.info(f"‚úÖ Found 'Direction G√©n√©rale': {direction_generale['id']}")
    
    # Step 3: Count children before deletion
    logger.info("\nüìä Step 3: Counting data to delete...")
    
    # Count direct children
    children = [u for u in org_units if u.get('parent_id') == direction_generale['id']]
    logger.info(f"  ‚Ä¢ Direct children: {len(children)}")
    logger.info(f"  ‚Ä¢ Total organization units: {len(org_units)}")
    
    # Count positions
    positions_response = session.get(
        f"{base_url}/api/identity/positions",
        cookies=cookies
    )
    
    if positions_response.status_code == 200:
        positions = positions_response.json()
        logger.info(f"  ‚Ä¢ Total positions: {len(positions)}")
    
    # Step 4: Delete Direction G√©n√©rale (cascade)
    logger.info("\nüóëÔ∏è Step 4: Deleting 'Direction G√©n√©rale' (cascade delete)...")
    
    confirm = input("\n‚ö†Ô∏è  This will delete ALL organization units and positions. Continue? [y/N]: ")
    
    if confirm.lower() != 'y':
        logger.info("‚ùå Cleanup cancelled by user")
        return 0
    
    delete_response = session.delete(
        f"{base_url}/api/identity/organization_units/{direction_generale['id']}",
        cookies=cookies
    )
    
    if delete_response.status_code == 204:
        logger.info("\n" + "=" * 80)
        logger.info("‚úÖ SUCCESS - All test data deleted!")
        logger.info("=" * 80)
        logger.info("üìù Deleted:")
        logger.info("  ‚Ä¢ Direction G√©n√©rale (root)")
        logger.info(f"  ‚Ä¢ All {len(org_units) - 1} child organization units (cascade)")
        logger.info("  ‚Ä¢ All positions (cascade)")
        return 0
    else:
        logger.error(f"\n‚ùå Delete failed: {delete_response.status_code} - {delete_response.text}")
        return 1


if __name__ == "__main__":
    sys.exit(main())
